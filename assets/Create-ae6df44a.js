import{I as ie}from"./InputQty-2fd7c74f.js";import{O as re,S as de}from"./OperateSuccessDialog-625e61fd.js";import{_ as J,d as X,$ as Z,r as L,o as p,m as M,l as v,b as t,t as n,j as e,c as $,a as c,z as x,T as S,A as f,q as G,y as O,H as ee,B,a1 as ue,u as ke,g as m,f as ve,i as pe,F as j,n as k,p as K,G as q,a3 as z,E as fe,K as me,a2 as b,C as he}from"./index-1733633f.js";import{B as Q}from"./bignumber-3e8dfdf6.js";const _e={class:"ave-popup"},we={class:"title"},ye={class:"body"},ge={class:"info"},Ce={class:"key"},be={class:"value"},$e={key:0,class:"token"},Ae={key:1,class:"token"},Ie={key:2,class:"token"},Te={class:"key"},Le={class:"value"},Se={class:"key"},De={class:"value"},Ne={class:"key"},Ee={class:"value"},Me={class:"blue-font"},Be={class:"key"},Ge={class:"value"},Oe={class:"tips"},Ue={__name:"LockConfirmPopup",props:{show:Boolean,showGas:String,amount:String,unlockDate:Date},emits:["update:show","confirm"],setup(y,{emit:d}){const w=y;X();const l=Z();function D(){d("confirm")}return(i,r)=>{const o=L("van-button"),U=L("van-popup");return p(),M(U,{show:y.show,"onUpdate:show":r[0]||(r[0]=g=>{d("update:show",g)}),round:"",closeable:"",position:"bottom"},{default:v(()=>[t("div",_e,[t("div",we,n(i.$t("lockConfirm")),1),t("div",ye,[t("ul",ge,[t("li",null,[t("div",Ce,n(i.$t("lockAssets")),1),t("div",be,[e(l).token?e(l).token.tokenType==0?(p(),$("div",Ae,[c(S,{class:"token-icon",tokenIcon:e(l).token.icon,chainIcon:e(x)(e(l).token.chain)},null,8,["tokenIcon","chainIcon"]),f(" "+n(`${e(l).token.symbol} (${e(G)(e(l).token.address)})`),1)])):e(l).token.tokenType==1?(p(),$("div",Ie,[c(S,{class:"token-icon",tokenIcon:e(O)(e(l).token.chain,e(l).token.tokenList[0].address)},null,8,["tokenIcon"]),c(S,{class:"token-icon",tokenIcon:e(O)(e(l).token.chain,e(l).token.tokenList[1].address)},null,8,["tokenIcon"]),f(" "+n(`${e(l).token.symbol} (${e(G)(e(l).token.address)})`),1)])):ee("",!0):(p(),$("div",$e," -- "))])]),t("li",null,[t("div",Te,n(i.$t("lockNumber")),1),t("div",Le,n(y.amount),1)]),t("li",null,[t("div",Se,n(i.$t("contractChian")),1),t("div",De,n(e(l).token?e(l).token.chain.toUpperCase():"--"),1)]),t("li",null,[t("div",Ne,n(i.$t("unlockTime2")),1),t("div",Ee,[t("span",null,n(e(B)(y.unlockDate).format("YYYY-MM-DD")),1),t("span",null,[f("("),t("span",Me,n(i.$t("dayLeft",{day:e(ue)(w.unlockDate)})),1),f(")")])])]),t("li",null,[t("div",Be,n(i.$t("serviceFee")),1),t("div",Ge,n(e(l).token&&y.showGas?`${y.showGas} ${e(l).token.chainCoinSymbol.toUpperCase()}`:"--"),1)])]),t("div",Oe,[t("div",null,n(i.$t("createTips1")),1),t("div",null,n(i.$t("createTips2")),1),t("div",null,n(i.$t("createTips3")),1)]),c(o,{class:"btn",type:"primary",block:"",onClick:D},{default:v(()=>[f(n(i.$t("confirmAndLock")),1)]),_:1})])])]),_:1},8,["show"])}}},Pe=J(Ue,[["__scopeId","data-v-018fc5ae"]]);const Fe={class:"body"},Re={class:"title token-title"},We={key:0,class:"token-box"},He={key:1,class:"token"},Ve={class:"title"},Ye={class:"title"},je={__name:"Create",setup(y){const{t:d}=ke(),w=m(!1),l=m(!1),D=m(!1),i=ve(),r=X(),o=Z(),U=B().add(1,"day").endOf("day").toDate(),g=m(U),C=m(""),E=m(!1),H=m(""),P=m(!1),F=m(""),A=m("");async function te(){await r.connectWallet()}async function V(){if(o.token==null)return;if(o.token.address==k.wallet.MAIN_COIN_ADDRESS){w.value=!1;return}await k.wallet.isAllowanceEnough(o.lockContractAddress,o.token.address,r.walletAddress)?w.value=!1:w.value=!0}async function oe(){l.value=!0;try{console.log("approve");let a=await k.wallet.approveMaxAmount(o.token.address,o.lockContractAddress);console.log(a),await a.wait(),w.value=!1}catch(a){console.log(a)}finally{l.value=!1}}async function ne(){D.value=!0,F.value="";try{if(!o.token){b(d("pleaseSelectToken"));return}if(!C.value){b(d("enterAmount"));return}let a=he[r.dappType].chainList.find(s=>s.chain==o.token.chain);if(!a){b(d("tokenChainNotSupport"));return}if(r.chain!=a.chain){b(d("switchTokenChain"));try{await k.wallet.switchNetwork(a.chainId)}catch{b(d("switchTokenChain"));return}return}if(Q(C.value).gt(Q(A.value))){b(d("balanceSlow"));return}if(await V(),w.value){b(d("approveFirst"));return}await ae()}catch(a){console.log(a)}finally{D.value=!1}}async function ae(){const a=o.token.address,h=await(await k.wallet.contractERC20(a)).decimals(),_=r.walletAddress,I=o.token.tokenType==1,N=q(C.value,h),u=B(g.value).endOf("day").unix(),R="",W=await k.wallet.contractLockMaster(o.lockContractAddress),T=await k.wallet.getGasPrice();let Y=await W.lock.estimateGas(_,a,I,N.toString(),u,R);console.dir(Y),H.value=z(Y*T),E.value=!0}async function se(){const a=K({message:"Loading...",forbidClick:!0,duration:0}),s=o.token.address,h=r.walletAddress,_=o.token.tokenType==1,N=await(await k.wallet.contractERC20(s)).decimals(),u=q(C.value,N),R=B(g.value).endOf("day").unix(),W=await k.wallet.contractLockMaster(o.lockContractAddress);try{let T=await W.lock(h,s,_,u.toString(),R,"");console.dir(T),F.value=T.hash,P.value=!0,E.value=!1}catch(T){console.log(T)}finally{a.close()}}function le(){i.push("/lockMaster/selectToken")}async function ce(){if(!o.token)return;const a=K({message:"Loading...",forbidClick:!0,duration:0});try{if(o.token.address==k.wallet.MAIN_COIN_ADDRESS){const h=await(await k.wallet.getEthersProvider()).getBalance(r.walletAddress);A.value=z(h)}else{const s=await k.wallet.contractERC20(o.token.address),h=await s.decimals(),_=await s.balanceOf(r.walletAddress);A.value=fe(_,h)}}catch(s){console.log(s),o.token=null}finally{a.close()}}return pe(()=>{console.log("onMounted"),r.chainId>0&&r.isConnectWallet&&o.token&&(V(),ce())}),(a,s)=>{const h=L("van-cell"),_=L("van-cell-group"),I=L("van-button"),N=L("van-action-bar");return p(),$(j,null,[t("div",Fe,[c(_,{inset:"",class:"form-item"},{default:v(()=>[t("div",Re,n(a.$t("selectToken2")),1),c(h,{"is-link":"",class:"token-cell",onClick:le},me({_:2},[e(o).token?{name:"title",fn:v(()=>[e(o).token.tokenType==0?(p(),$("div",We,[c(S,{class:"token-icon",tokenIcon:e(o).token.icon,chainIcon:e(x)(e(o).token.chain)},null,8,["tokenIcon","chainIcon"]),f(" "+n(`${e(o).token.symbol} (${e(G)(e(o).token.address)})`),1)])):e(o).token.tokenType==1?(p(),$("div",He,[c(S,{class:"token-icon",tokenIcon:e(O)(e(o).token.chain,e(o).token.tokenList[0].address)},null,8,["tokenIcon"]),c(S,{class:"token-icon",tokenIcon:e(O)(e(o).token.chain,e(o).token.tokenList[1].address)},null,8,["tokenIcon"]),f(" "+n(`${e(o).token.symbol} (${e(G)(e(o).token.address)})`),1)])):ee("",!0)]),key:"0"}:{name:"title",fn:v(()=>[t("div",{class:"token-box",style:{color:"#999999"}},n(a.$t("pleaseSelectToken")),1)]),key:"1"}]),1024)]),_:1}),c(_,{inset:"",class:"form-item"},{default:v(()=>[t("div",Ve,[t("div",null,n(e(d)("setNumberOfLock")),1),t("div",null,[f(n(`${e(d)("balance")}: `),1),t("span",null,n(A.value?A.value:"--"),1)])]),t("div",null,[c(ie,{amount:C.value,"onUpdate:amount":s[0]||(s[0]=u=>C.value=u),total:A.value,decimals:e(o).token?e(o).token.decimals:0},null,8,["amount","total","decimals"])])]),_:1}),c(_,{inset:"",class:"form-item"},{default:v(()=>[t("div",Ye,[t("div",null,n(a.$t("setDate")),1)]),t("div",null,[c(de,{date:g.value,"onUpdate:date":s[1]||(s[1]=u=>g.value=u),showTools:""},null,8,["date"])])]),_:1})]),c(N,{class:"tools"},{default:v(()=>[e(r).isConnectWallet?(p(),$(j,{key:0},[w.value?(p(),M(I,{key:0,class:"btn",type:"danger",onClick:oe,block:"",loading:l.value},{default:v(()=>[f(n(a.$t("approve")),1)]),_:1},8,["loading"])):(p(),M(I,{key:1,class:"btn",color:"#3F80F7",onClick:ne,block:"",loading:D.value},{default:v(()=>[f(n(a.$t("oneKeyLock")),1)]),_:1},8,["loading"]))],64)):(p(),M(I,{key:1,class:"btn",type:"primary",onClick:te,block:""},{default:v(()=>[f(n(a.$t("connectWallet")),1)]),_:1}))]),_:1}),c(Pe,{show:E.value,"onUpdate:show":s[2]||(s[2]=u=>E.value=u),unlockDate:g.value,amount:C.value,showGas:H.value,onConfirm:se},null,8,["show","unlockDate","amount","showGas"]),c(re,{show:P.value,"onUpdate:show":s[3]||(s[3]=u=>P.value=u),txHash:F.value,onClose:s[4]||(s[4]=u=>e(i).push("/lockMaster"))},null,8,["show","txHash"])],64)}}},Je=J(je,[["__scopeId","data-v-c7ea8f36"]]);export{Je as default};
